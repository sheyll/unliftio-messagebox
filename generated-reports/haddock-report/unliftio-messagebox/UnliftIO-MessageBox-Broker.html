<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>UnliftIO.MessageBox.Broker</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">unliftio-messagebox-2.1.0: Fast and robust message queues for concurrent processes</span><ul class="links" id="page-menu"><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">UnliftIO.MessageBox.Broker</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>A broker extracts a <em>key</em> value from incoming messages
  and creates, keeps and destroys a <em>resource</em> for each key.</p><p>The demultiplexed messages and their resources are passed to
 a custom <code><a href="UnliftIO-MessageBox-Broker.html#t:MessageHandler" title="UnliftIO.MessageBox.Broker">MessageHandler</a></code>/</p><p>The user provides a <code><a href="UnliftIO-MessageBox-Broker.html#t:Demultiplexer" title="UnliftIO.MessageBox.Broker">Demultiplexer</a></code> is a pure function that
 returns a key for the resource associated
 to the message and potientially changes the
 message.</p><p>The demultiplexer may also return a value indicating that
 a new resource must be created, or that a message
 shall be ignored.</p><p>The broker is run in a seperate process using <code>async</code>.
 The usual way to stop a broker is to <code>cancel</code> it.</p><p>When cancelling a broker, the resource cleanup
 actions for all resources will be called with
 async exceptions masked.</p><p>In order to prevent the resource map filling up with
 <em>dead</em> resources, the user of this module has to ensure
 that whenever a resource is not required anymore, a message
 will be sent to the broker, that will cause the <code><a href="UnliftIO-MessageBox-Broker.html#t:MessageHandler" title="UnliftIO.MessageBox.Broker">MessageHandler</a></code>
 to be executed for the resource, which will in turn return,
 return <code><a href="UnliftIO-MessageBox-Broker.html#v:RemoveResource" title="UnliftIO.MessageBox.Broker">RemoveResource</a></code>.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:spawnBroker">spawnBroker</a> :: <span class="keyword">forall</span> brokerBoxArg k w' w a m. (MonadUnliftIO m, Ord k, <a href="UnliftIO-MessageBox-Class.html#t:IsMessageBoxArg" title="UnliftIO.MessageBox.Class">IsMessageBoxArg</a> brokerBoxArg) =&gt; brokerBoxArg -&gt; <a href="UnliftIO-MessageBox-Broker.html#t:BrokerConfig" title="UnliftIO.MessageBox.Broker">BrokerConfig</a> k w' w a m -&gt; m (Either SomeException (<a href="UnliftIO-MessageBox-Class.html#t:Input" title="UnliftIO.MessageBox.Class">Input</a> (<a href="UnliftIO-MessageBox-Class.html#t:MessageBox" title="UnliftIO.MessageBox.Class">MessageBox</a> brokerBoxArg) w', Async <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a>))</li><li class="src short"><span class="keyword">data</span> <a href="#t:BrokerConfig">BrokerConfig</a> k w' w a m = <a href="#v:MkBrokerConfig">MkBrokerConfig</a> {<ul class="subs"><li><a href="#v:demultiplexer">demultiplexer</a> :: !(<a href="UnliftIO-MessageBox-Broker.html#t:Demultiplexer" title="UnliftIO.MessageBox.Broker">Demultiplexer</a> w' k w)</li><li><a href="#v:messageDispatcher">messageDispatcher</a> :: !(<a href="UnliftIO-MessageBox-Broker.html#t:MessageHandler" title="UnliftIO.MessageBox.Broker">MessageHandler</a> k w a m)</li><li><a href="#v:resourceCreator">resourceCreator</a> :: !(<a href="UnliftIO-MessageBox-Broker.html#t:ResourceCreator" title="UnliftIO.MessageBox.Broker">ResourceCreator</a> k w a m)</li><li><a href="#v:resourceCleaner">resourceCleaner</a> :: !(<a href="UnliftIO-MessageBox-Broker.html#t:ResourceCleaner" title="UnliftIO.MessageBox.Broker">ResourceCleaner</a> k a m)</li></ul>}</li><li class="src short"><span class="keyword">data</span> <a href="#t:BrokerResult">BrokerResult</a> = <a href="#v:MkBrokerResult">MkBrokerResult</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:ResourceCreator">ResourceCreator</a> k w a m = k -&gt; Maybe w -&gt; m a</li><li class="src short"><span class="keyword">type</span> <a href="#t:Demultiplexer">Demultiplexer</a> w' k w = w' -&gt; <a href="UnliftIO-MessageBox-Broker.html#t:Multiplexed" title="UnliftIO.MessageBox.Broker">Multiplexed</a> k w</li><li class="src short"><span class="keyword">type</span> <a href="#t:ResourceCleaner">ResourceCleaner</a> k a m = k -&gt; a -&gt; m ()</li><li class="src short"><span class="keyword">type</span> <a href="#t:MessageHandler">MessageHandler</a> k w a m = k -&gt; w -&gt; a -&gt; m (<a href="UnliftIO-MessageBox-Broker.html#t:ResourceUpdate" title="UnliftIO.MessageBox.Broker">ResourceUpdate</a> a)</li><li class="src short"><span class="keyword">data</span> <a href="#t:Multiplexed">Multiplexed</a> k w<ul class="subs"><li>= <a href="#v:Initialize">Initialize</a> k !(Maybe w)</li><li>| <a href="#v:Dispatch">Dispatch</a> k w</li></ul></li><li class="src short"><span class="keyword">data</span> <a href="#t:ResourceUpdate">ResourceUpdate</a> a<ul class="subs"><li>= <a href="#v:KeepResource">KeepResource</a></li><li>| <a href="#v:UpdateResource">UpdateResource</a> a</li><li>| <a href="#v:RemoveResource">RemoveResource</a> !(Maybe a)</li></ul></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:spawnBroker" class="def">spawnBroker</a> :: <span class="keyword">forall</span> brokerBoxArg k w' w a m. (MonadUnliftIO m, Ord k, <a href="UnliftIO-MessageBox-Class.html#t:IsMessageBoxArg" title="UnliftIO.MessageBox.Class">IsMessageBoxArg</a> brokerBoxArg) =&gt; brokerBoxArg -&gt; <a href="UnliftIO-MessageBox-Broker.html#t:BrokerConfig" title="UnliftIO.MessageBox.Broker">BrokerConfig</a> k w' w a m -&gt; m (Either SomeException (<a href="UnliftIO-MessageBox-Class.html#t:Input" title="UnliftIO.MessageBox.Class">Input</a> (<a href="UnliftIO-MessageBox-Class.html#t:MessageBox" title="UnliftIO.MessageBox.Class">MessageBox</a> brokerBoxArg) w', Async <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a>)) <a href="#v:spawnBroker" class="selflink">#</a></p><div class="doc"><p>Spawn a broker with a new <code><a href="UnliftIO-MessageBox-Class.html#t:MessageBox" title="UnliftIO.MessageBox.Class">MessageBox</a></code>,
  and return its message <code><a href="UnliftIO-MessageBox-Class.html#t:Input" title="UnliftIO.MessageBox.Class">Input</a></code> channel as well as
 the <code>Async</code> handle of the spawned process, needed to
 stop the broker process.</p><ul><li><code>k</code> is the <em>key</em> for the resource associated to an incoming
   message</li><li><code>w'</code> is the type of incoming messages.</li><li><code>w</code> is the type of the demultiplexed messages.</li><li><code>a</code> specifies the resource type.</li><li><code>m</code> is the base monad</li></ul></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:BrokerConfig" class="def">BrokerConfig</a> k w' w a m <a href="#t:BrokerConfig" class="selflink">#</a></p><div class="doc"><p>The broker configuration, used by <code><a href="UnliftIO-MessageBox-Broker.html#v:spawnBroker" title="UnliftIO.MessageBox.Broker">spawnBroker</a></code>.</p><ul><li><code>k</code> is the <em>key</em> for the resource associated to an incoming
   message</li><li><code>w'</code> is the type of incoming messages.</li><li><code>w</code> is the type of the demultiplexed messages.</li><li><code>a</code> specifies the resource type.</li><li><code>m</code> is the base monad</li></ul></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:MkBrokerConfig" class="def">MkBrokerConfig</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:demultiplexer" class="def">demultiplexer</a> :: !(<a href="UnliftIO-MessageBox-Broker.html#t:Demultiplexer" title="UnliftIO.MessageBox.Broker">Demultiplexer</a> w' k w)</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:messageDispatcher" class="def">messageDispatcher</a> :: !(<a href="UnliftIO-MessageBox-Broker.html#t:MessageHandler" title="UnliftIO.MessageBox.Broker">MessageHandler</a> k w a m)</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:resourceCreator" class="def">resourceCreator</a> :: !(<a href="UnliftIO-MessageBox-Broker.html#t:ResourceCreator" title="UnliftIO.MessageBox.Broker">ResourceCreator</a> k w a m)</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:resourceCleaner" class="def">resourceCleaner</a> :: !(<a href="UnliftIO-MessageBox-Broker.html#t:ResourceCleaner" title="UnliftIO.MessageBox.Broker">ResourceCleaner</a> k a m)</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:BrokerResult" class="def">BrokerResult</a> <a href="#t:BrokerResult" class="selflink">#</a></p><div class="doc"><p>This is just what the <code>Async</code> returned from
 <code><a href="UnliftIO-MessageBox-Broker.html#v:spawnBroker" title="UnliftIO.MessageBox.Broker">spawnBroker</a></code> returns, it's current purpose is to
 make code easier to read.</p><p>Instead of some <code>Async ()</code> that could be anything,
 there is <code>Async BrokerResult</code>.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:MkBrokerResult" class="def">MkBrokerResult</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><h4 class="instances details-toggle-control details-toggle" data-details-id="i:BrokerResult">Instances</h4><details id="i:BrokerResult" open="open"><summary class="hide-when-js-enabled">Instances details</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:BrokerResult:Eq:1"></span> Eq <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a></span> <a href="#t:BrokerResult" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:BrokerResult:Eq:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="UnliftIO-MessageBox-Broker.html">UnliftIO.MessageBox.Broker</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-61--61-">(==)</a> :: <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a> -&gt; <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a> -&gt; Bool</p><p class="src"><a href="#v:-47--61-">(/=)</a> :: <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a> -&gt; <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a> -&gt; Bool</p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:BrokerResult:Show:2"></span> Show <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a></span> <a href="#t:BrokerResult" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:BrokerResult:Show:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="UnliftIO-MessageBox-Broker.html">UnliftIO.MessageBox.Broker</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> :: Int -&gt; <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a> -&gt; ShowS</p><p class="src"><a href="#v:show">show</a> :: <a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a> -&gt; String</p><p class="src"><a href="#v:showList">showList</a> :: [<a href="UnliftIO-MessageBox-Broker.html#t:BrokerResult" title="UnliftIO.MessageBox.Broker">BrokerResult</a>] -&gt; ShowS</p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:ResourceCreator" class="def">ResourceCreator</a> k w a m = k -&gt; Maybe w -&gt; m a <a href="#t:ResourceCreator" class="selflink">#</a></p><div class="doc"><p>User supplied callback to create and initialize a resource.
  (Sync-) Exceptions thrown from this function are caught,
  and the broker continues.</p><ul><li><code>k</code> is the <em>key</em> for the resource associated to an incoming
   message</li><li><code>w</code> is the type of the demultiplexed messages.</li><li><code>a</code> specifies the resource type.</li><li><code>m</code> is the monad of the returned action.</li></ul></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:Demultiplexer" class="def">Demultiplexer</a> w' k w = w' -&gt; <a href="UnliftIO-MessageBox-Broker.html#t:Multiplexed" title="UnliftIO.MessageBox.Broker">Multiplexed</a> k w <a href="#t:Demultiplexer" class="selflink">#</a></p><div class="doc"><p>User supplied callback to extract the key and the <code><a href="UnliftIO-MessageBox-Broker.html#t:Multiplexed" title="UnliftIO.MessageBox.Broker">Multiplexed</a></code>
  from a message.
  (Sync-) Exceptions thrown from this function are caught and lead
  to dropping of the incoming message, while the broker continues.</p><ul><li><code>k</code> is the <em>key</em> for the resource associated to an incoming
   message</li><li><code>w'</code> is the type of incoming messages.</li><li><code>w</code> is the type of the demultiplexed messages.</li></ul></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:ResourceCleaner" class="def">ResourceCleaner</a> k a m = k -&gt; a -&gt; m () <a href="#t:ResourceCleaner" class="selflink">#</a></p><div class="doc"><p>User supplied callback called _with exceptions masked_
 when the <code><a href="UnliftIO-MessageBox-Broker.html#t:MessageHandler" title="UnliftIO.MessageBox.Broker">MessageHandler</a></code> returns <code><a href="UnliftIO-MessageBox-Broker.html#v:RemoveResource" title="UnliftIO.MessageBox.Broker">RemoveResource</a></code>
 (Sync-) Exceptions thrown from this function are caught,
 and do not prevent the removal of the resource, also the
 broker continues.</p><ul><li><code>k</code> is the <em>key</em> for the resource associated to an incoming
   message</li><li><code>a</code> specifies the resource type.</li><li><code>m</code> is the monad of the returned action.</li></ul></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:MessageHandler" class="def">MessageHandler</a> k w a m = k -&gt; w -&gt; a -&gt; m (<a href="UnliftIO-MessageBox-Broker.html#t:ResourceUpdate" title="UnliftIO.MessageBox.Broker">ResourceUpdate</a> a) <a href="#t:MessageHandler" class="selflink">#</a></p><div class="doc"><p>User supplied callback to use the <code><a href="UnliftIO-MessageBox-Broker.html#t:Multiplexed" title="UnliftIO.MessageBox.Broker">Multiplexed</a></code> message and
  the associated resource.
  (Sync-) Exceptions thrown from this function are caught and lead
  to immediate cleanup of the resource but the broker continues.</p><ul><li>Type <code>k</code> is the <em>key</em> for the resource associated to an incoming
   message</li><li>Type <code>w</code> is the type of incoming, demultiplexed, messages.</li><li>Type <code>a</code> specifies the resource type.</li><li>Type <code>m</code> is the base monad</li></ul></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Multiplexed" class="def">Multiplexed</a> k w <a href="#t:Multiplexed" class="selflink">#</a></p><div class="doc"><p>The action that the broker has to take for in incoming message.</p><ul><li><code>k</code> is the <em>key</em> for the resource associated to an incoming
   message</li><li><code>w</code> is the type of the demultiplexed messages.</li></ul></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Initialize" class="def">Initialize</a> k !(Maybe w)</td><td class="doc"><p>The message is an initialization message, that requires the
   creation of a new resouce for the given key.
   When the resource is created, then <em>maybe</em> additionally
   a message will also be dispatched.</p></td></tr><tr><td class="src"><a id="v:Dispatch" class="def">Dispatch</a> k w</td><td class="doc"><p>Dispatch a message using an existing resource.
 Silently ignore if no resource for the key exists.</p></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ResourceUpdate" class="def">ResourceUpdate</a> a <a href="#t:ResourceUpdate" class="selflink">#</a></p><div class="doc"><p>This value indicates in what state a worker is in after the
  <code><a href="UnliftIO-MessageBox-Broker.html#t:MessageHandler" title="UnliftIO.MessageBox.Broker">MessageHandler</a></code> action was executed.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:KeepResource" class="def">KeepResource</a></td><td class="doc"><p>The resources is still required.</p></td></tr><tr><td class="src"><a id="v:UpdateResource" class="def">UpdateResource</a> a</td><td class="doc"><p>The resource is still required but must be updated.</p></td></tr><tr><td class="src"><a id="v:RemoveResource" class="def">RemoveResource</a> !(Maybe a)</td><td class="doc"><p>The resource is obsolete and can
   be removed from the broker.
   The broker will call <code><a href="UnliftIO-MessageBox-Broker.html#t:ResourceCleaner" title="UnliftIO.MessageBox.Broker">ResourceCleaner</a></code> either
   on the current, or an updated resource value.</p></td></tr></table></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.24.0</p></div></body></html>